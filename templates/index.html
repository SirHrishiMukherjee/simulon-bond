<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SimuLang Web IDE</title>
    <style>
        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #dcdcdc;
            padding: 20px;
        }
        .codebox {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #444;
            margin-bottom: 10px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #2d2d2d;
            color: #dcdcdc;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            user-select: none;
        }
        .tab.active {
            background: #007acc;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        textarea {
            width: 100%;
            height: 300px;
            background: #252526;
            color: #dcdcdc;
            font-family: monospace;
            border: 1px solid #333;
            padding: 10px;
            resize: vertical;
        }
        .highlightPreview {
            background: #1e1e1e;
            border: 1px solid #444;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .token { display: inline; }
        .token.keyword { color: #c586c0; }
        .token.identifier { color: #9cdcfe; }
        .token.number { color: #b5cea8; }
        .token.string { color: #ce9178; }
        .token.symbol { color: #d4d4d4; }
        .token.sol { color: #ff6f00; font-weight: bold; }
        .token.phase { color: #ff6f00; }
        .token.attribute { color: #d7ba7d; }
        button {
            margin-top: 10px;
            padding: 10px 20px;
            background: #007acc;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        pre {
            background: #2d2d2d;
            padding: 10px;
            border: 1px solid #444;
            margin-top: 20px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>SimuLang Web IDE</h1>
    <div class="codebox">
        <div class="tabs">
            <div class="tab active" data-tab="example1">Example 1: Infinity Loop</div>
            <div class="tab" data-tab="example2">Example 2: Basic Constructs</div>
            <div class="tab" data-tab="example3">Example 3: Martian Sol</div>
        </div>

        <div class="tab-content active" id="example1">
            <textarea id="code-example1">coeternal light := ∞;

posit varnothing nabla infty ds2(): {
    octyl time := 1;
    time := time + 1;
    print(time);
    intertillage [2∞..10∞] -> i: {
        time := i + time;
        print(time);
    }
}</textarea>
            <div id="highlightPreview-example1" class="highlightPreview"></div>
        </div>

        <div class="tab-content" id="example2">
            <textarea id="code-example2">coeternal light := ∞;

posit varnothing nabla infty ds2(): {
    intertillage [0..∞] -> x: { print(x); }
    delineator "boundary": { octyl time := 1; print(time); print(light); }
    bifurcator ∞[2∞, 3∞] -> a(b, x): { print(a); print(b); print(x); }
    octyl field_generator := 100;
    equiangular field_generator == 100: { print("Simulonic Field Generator is on."); }
    boundary [0..∞] -> frame: { print(frame); }
    boundary [0..2∞] -> b_frame: { print(b_frame); }
    boundary [0..3∞] -> c_frame: { print(c_frame); }
    recur ds2(10∞);
}</textarea>
            <div id="highlightPreview-example2" class="highlightPreview"></div>
        </div>

        <div class="tab-content" id="example3">
            <textarea id="code-example3">coeternal light := ∞;

posit varnothing nabla infty ds2(): {
    sol day intensity 0.9 {
        print("Martian Daytime.");
        intertillage [∞..∞+10] -> d: {
            print(d);
        }
    }
    sol night duration 12.3 {
        print("Martian Nighttime.");
        delineator "cycle begin": {
            print("Cycle is beginning. Delineating...");
        }
    }
    sol day duration 12.3 {
        print("Martian Daytime.");
        intertillage [∞..∞+20] -> d: {
            print(d);
        } 
    }
    sol night intensity 0.6 {
        print("Martian Nighttime.");
        delineator "cycle end": {
            print("Cycle is ending. Delineating...");
        }
    }
}</textarea>
            <div id="highlightPreview-example3" class="highlightPreview"></div>
        </div>

        <div class="buttons">
            <button onclick="compileCode()">Compile Only</button>
            <button onclick="runCode()">Run</button>
            <button onclick="stopCode()">Stop</button>
        </div>
        <pre id="output"></pre>
    </div>

    <script>
        let outputInterval = null;

        // Tab switching logic
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                highlightAllPreviews();
            });
        });

        function getActiveCode() {
            const activeTab = document.querySelector('.tab-content.active textarea');
            return activeTab ? activeTab.value : '';
        }

        async function compileCode() {
            const code = getActiveCode();
            const output = document.getElementById("output");
            output.textContent = "Compiling...\n";
            try {
                const response = await fetch('/compile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const result = await response.json();
                output.textContent = result.output || ('Error: ' + result.error + '\n');
            } catch (e) {
                output.textContent = 'Error: Network issue or server error\n';
            }
        }

        async function runCode() {
            const code = getActiveCode();
            const output = document.getElementById("output");
            output.textContent = "Executing...\n";
            try {
                const response = await fetch('/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const result = await response.json();
                output.textContent = result.output;
                startOutputLoop();
            } catch (e) {
                output.textContent = 'Error: Failed to start execution\n';
            }
        }

        async function stopCode() {
            const output = document.getElementById("output");
            try {
                const response = await fetch('/stop', { method: 'POST' });
                const result = await response.json();
                output.textContent += result.status;
                if (outputInterval) {
                    clearInterval(outputInterval);
                    outputInterval = null;
                }
            } catch (e) {
                output.textContent += '\nError: Failed to stop execution';
            }
        }

        function startOutputLoop() {
            if (outputInterval) clearInterval(outputInterval);
            outputInterval = setInterval(async () => {
                try {
                    const res = await fetch('/fetch_output');
                    const data = await res.json();
                    document.getElementById("output").textContent = data.output;
                    if (data.done) {
                        clearInterval(outputInterval);
                        outputInterval = null;
                        document.getElementById("output").textContent += '\n✅ Execution complete.';
                    }
                } catch (e) {
                    document.getElementById("output").textContent += '\nError: Output fetch failed';
                    clearInterval(outputInterval);
                    outputInterval = null;
                }
            }, 500);
        }

        // --- Highlighting logic ---
        function tokenize(code) {
            // Dummy tokenizer: Replace this with your real one
            const words = code.split(/(\s+|[^a-zA-Z0-9_])/).filter(Boolean);
            return words.map(word => {
                if (/^\d/.test(word)) return ['NUMBER', word];
                if (/^".*"$/.test(word)) return ['STRING', word];
                if (word === 'coeternal' || word === 'posit' || word === 'varnothing' || word === 'nabla' || word === 'infty' || word === 'octyl' || word === 'intertillage' || word === 'print' || word === 'equiangular') return ['KEYWORD', word];
                if (word === 'sol') return ['SOL', word];
                if (word === 'day' || word === 'night') return ['PHASE', word];
                if (word === 'intensity' || word === 'duration') return ['ATTRIBUTE', word];
                if (/[\(\)\{\}\[\]:=.,+*/-]/.test(word)) return ['SYMBOL', word];
                return ['IDENTIFIER', word];
            });
        }

        function highlightPreview(textareaId, previewId) {
            const textarea = document.getElementById(textareaId);
            const preview = document.getElementById(previewId);
            const tokens = tokenize(textarea.value);
            preview.innerHTML = tokens.map(([type, value]) => {
                let className = 'token';
                if (type === 'KEYWORD') className += ' keyword';
                else if (type === 'IDENTIFIER') className += ' identifier';
                else if (type === 'NUMBER') className += ' number';
                else if (type === 'STRING') className += ' string';
                else if (type === 'SYMBOL') className += ' symbol';
                else if (type === 'SOL') className += ' sol';
                else if (type === 'PHASE') className += ' phase';
                else if (type === 'ATTRIBUTE') className += ' attribute';
                return `<span class="${className}">${value}</span>`;
            }).join('');
        }

        function highlightAllPreviews() {
            highlightPreview("code-example1", "highlightPreview-example1");
            highlightPreview("code-example2", "highlightPreview-example2");
            highlightPreview("code-example3", "highlightPreview-example3");
        }

        // Initialize preview highlighting on load
        window.addEventListener('load', highlightAllPreviews);
    </script>
</body>
</html>
